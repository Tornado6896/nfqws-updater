#!/bin/sh

#–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
RoutID="$(echo $(hostname) | tr '[:lower:]' '[:upper:]')"
green="\033[32m"
red="\033[31m"
yellow="\033[33m"
reset="\033[0m" 
echo -e "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ ${yellow}crontab${reset}"
var="/opt/usr/bin/nfqws_var"
if [ ! -e "${var}" ]; then
echo -e "–§–∞–π–ª ${red}crontab${reset} –Ω–µ –Ω–∞–π–¥–µ–Ω"
touch /opt/usr/bin/nfqws_var
chmod +x "${var}"
echo -e "–§–∞–π–ª ${green}crontab${reset} —Å–æ–∑–¥–∞–Ω";
else
echo -e "–§–∞–π–ª ${yellow}crontab${reset} —É–∂–µ —Å—É—â–µ—Å—Ç–≤–µ—Ç";
fi
source $var

# –§—É–Ω–∫—Ü–∏–∏
function sendTelegram {
  local tgUrl="https://api.telegram.org/bot$tgToken/sendMessage"
  local tgTimeout="10"
  local tgText="$@"
  local tgCmdArgs="parse_mode=HTML&chat_id=$tgChatId&disable_web_page_preview=1&text=$tgText"
  #source "/opt/usr/bin/nfqws_var"
  
  tgCmd=$(curl --max-time $tgTimeout -d "$tgCmdArgs" $tgUrl -s)
  if [ $? -gt 0 ]; then echo "–û—à–∏–±–∫–∞ –æ–ø—Ä–∞–≤–∫–∏ –≤ Telegram"; else echo "–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!"; fi

}
function sendupdatenfqws {

VerWeb2="$(opkg info nfqws-keenetic-web | grep "Version")"
Ver3="$(opkg info nfqws-keenetic | grep "Version:")"
 echo -e "${green}$RoutID${reset}: –°–ª—É–∂–±–∞ ${green}nfqws${reset} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ $Ver3. –°–ª—É–∂–±–∞ ${green}nfqws-web${reset} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ $VerWeb2";
     if [ -n "$tgToken" -a -n "$tgChatId" ]; then
      sendTelegram "$RoutID: üì¶ –°–ª—É–∂–±–∞ nfqws –æ–±–Ω–æ–≤–ª–µ–Ω–∞ üí° $Ver3. –°–ª—É–∂–±–∞ nfqws-web –æ–±–Ω–æ–≤–ª–µ–Ω–∞ üí° $VerWeb2";
	  restartnfqws
	  fi
	  }
function sendinstallnfqws {
VerWeb2="$(opkg info nfqws-keenetic-web | grep "Version")"
Ver3="$(opkg info nfqws-keenetic | grep "Version:")"
 echo -e "${green}$RoutID${reset}: –°–ª—É–∂–±–∞ ${green}nfqws${reset} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ $Ver3. –°–ª—É–∂–±–∞ ${green}nfqws-web${reset} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ $VerWeb2";
     if [ -n "$tgToken" -a -n "$tgChatId" ]; then
      sendTelegram "$RoutID: üì¶ –°–ª—É–∂–±–∞ nfqws —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ üí° $Ver3. –°–ª—É–∂–±–∞ nfqws-web —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ üí° $VerWeb2";
	  restartnfqws
	  fi
	  }
function sendupdatenfqwsno {
echo -e "${red}$RoutID${reset}: –û–±–Ω–æ–≤–ª–µ–Ω–∏–π ${red}nfqws${reset} –Ω–µ—Ç";
	 if [ -n "$tgToken" -a -n "$tgChatId" ]; then
	sendTelegram "$RoutID: ‚ùå –û–±–Ω–æ–≤–ª–µ–Ω–∏–π nfqws –Ω–µ—Ç";
  fi
}
function sendupdateuserlist {
echo -e "${red}$RoutID${reset}: userlist —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω, –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π $count3";
	  if [ -n "$tgToken" -a -n "$tgChatId" ]; then
	  sendTelegram "$RoutID: üìù userlist —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω, –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π üí° $count3";
	  fi
}
function sendupdateuserlistno {
 echo -e "${red}$RoutID${reset}:–û–±–Ω–æ–≤–ª–µ–Ω–∏—è ${red}userlist${reset} –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç";
	if [ -n "$tgToken" -a -n "$tgChatId" ]; then
	sendTelegram "$RoutID: ‚ùå –û–±–Ω–æ–≤–ª–µ–Ω–∏—è userlist –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç";
	fi
}
function restartnfqws {
echo -e "–ü–µ—Ä–µ–∞–≥—Ä—É–∑–∫–∞ ${green}nfqws${reset}"
/opt/etc/init.d/S51nfqws restart
echo -e "${yellow}$RoutID${reset}: –°–ª—É–∂–±–∞ ${yellow}nfqws${reset} –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞";
if [ -n "$tgToken" -a -n "$tgChatId" ]; then
	sendTelegram "$RoutID: ‚öôÔ∏è –°–ª—É–∂–±–∞ nfqws –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞";
	fi
}
function restartcron {
echo -e "–ü–µ—Ä–µ–∞–≥—Ä—É–∑–∫–∞ ${green}cron${reset}"
/opt/etc/init.d/S05crond restart;
echo -e "${yellow}$RoutID${reset}: –°–ª—É–∂–±–∞ ${yellow}cron${reset} –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞";
if [ -n "$tgToken" -a -n "$tgChatId" ]; then
sendTelegram "$RoutID: ‚öôÔ∏è –°–ª—É–∂–±–∞ cron –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞";
fi
}
function removenfqws {
echo -e "–£–¥–∞–ª–µ–Ω–∏–µ ${green}nfqws${reset}"
opkg remove --autoremove nfqws-keenetic-web nfqws-keenetic
rm -r /opt/var/spool/cron/crontabs
rm -r /opt/usr/bin/nfqws_var
deldns
delpolicy
}
function token {
echo -e "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ ${green}Telegram${reset}"

#var="/opt/usr/bin/nfqws_var"
echo –£–∫–∞–∂–∏—Ç–µ –í–∞—à tgToken:
read tgToken
echo -e "–í–∞—à —Ç–æ–∫–µ–Ω: $tgToken"
echo –£–∫–∞–∂–∏—Ç–µ –í–∞—à tgChatId:
read tgChatId
echo -e "–í–∞—à —á–∞—Ç: $tgChatId"
script='#!/bin/sh
tgToken="'${tgToken}'"
tgChatId="'${tgChatId}'"'     
      
	    	
        echo -e "${script}" > "${var}" 
        chmod +x "${var}"
	    echo -e "–§–∞–π–ª ${green}nfqws_var${reset} —Å–æ–∑–¥–∞–Ω"	
 
}
function updatenfqws {
Ver="$(opkg info nfqws-keenetic | grep "Version:")"
Ver2="$(curl -ss https://anonym-tsk.github.io/nfqws-keenetic/all/Packages | grep  -m1 -w -e "nfqws-keenetic-web"  -e "Version")"
echo -e "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${green}nfqws${reset}"

if  [ "$Ver" != "$Ver2" ]; then
opkg update
opkg upgrade nfqws-keenetic
opkg upgrade nfqws-keenetic-web

      sendupdatenfqws
else
	sendupdatenfqwsno
  fi
}
function menu {
            echo
            echo -e "     –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ${green}nfqws-updater v1.0.4${reset}"
            echo
            echo -e "     –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç:"
            echo -e "     1.  –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É ${green}nfqws${reset}"
			echo -e "     2.  –í—ã–ø–æ–ª–Ω–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É ${green}nfqws${reset}"
			echo -e "     3.  –í—ã–ø–æ–ª–Ω–∏–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${green}nfqws${reset}"
			echo -e "     4.  –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å ${green}nfqws${reset}"
			echo -e "     5.  –î–æ–±–∞–≤–∏—Ç—å ${green}DNS –∑–∞–ø–∏—Å–∏${reset}"
			echo -e "     6.  –î–æ–±–∞–≤–∏—Ç—å ${green}–ø–æ–ª–∏—Ç–∏–∫—É nfqws${reset}"
			echo -e "     7.  –£–¥–∞–ª–∏—Ç—å ${green}nfqws${reset}"
			echo -e "     8.  –£–¥–∞–ª–∏—Ç—å ${green}DNS –∑–∞–ø–∏—Å–∏${reset}"
			echo -e "     9.  –£–¥–∞–ª–∏—Ç—å ${green}–ø–æ–ª–∏—Ç–∏–∫—É nfqws${reset}"
			echo -e "     10. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å ${green}cron${reset}"
			echo -e "     11. –í—ã–ø–æ–ª–Ω–∏–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${green}userlist${reset}"
			echo -e "     12. –í—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π ${green}nfqws –∏ userlist${reset}"
            echo -e "     13. –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ ${green}telegram${reset}"
            echo -e "     00. –í—ã—Ö–æ–¥"
            echo -e 

            local choice
            while true; do
                read -p "  –í–∞—à –≤—ã–±–æ—Ä: " choice
                if [[ "$choice" =~ ^[0-9]$ || ^[0-9]+.*[0-9]$ ]]; then
                    break
                else
                    echo -e "  –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –¥–µ–π—Å—Ç–≤–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞,–≤—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–æ–≤–∞"
                fi
            done

            if [ "$choice" -eq 1 ]; then  
            installfull
            menu			
			fi			
            if [ "$choice" -eq 2 ]; then         
            installnfqws
			menu
			fi
			if [ "$choice" -eq 3 ]; then         
            updatenfqws
            menu			
			fi
			if [ "$choice" -eq 4 ]; then            
            restartnfqws
			menu
			fi
			if [ "$choice" -eq 5 ]; then            
            dnsadd
			menu
			fi
			if [ "$choice" -eq 6 ]; then
			addpolicy
			menu	
            fi	
			if [ "$choice" -eq 7 ]; then
			removenfqws
			menu	
            fi	
			if [ "$choice" -eq 8 ]; then
			deldns
			menu	
            fi
			if [ "$choice" -eq 9 ]; then
			delpolicy
			menu
			fi
			if [ "$choice" -eq 10 ]; then
			restartcron
			menu
			fi
		    if [ "$choice" -eq 11 ]; then
			userlist
			menu
			fi
			if [ "$choice" -eq 12 ]; then
			crontime
			menu
			fi
			if [ "$choice" -eq 13 ]; then
			token
			menu
			fi
			if [ "$choice" -eq 00 ]; then
			exit 0
				
fi

}
function crontime {
       
		local init_back="/opt/backups/"
        local initd_crontab="/opt/var/spool/cron/crontabs/root"
echo -e "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${green}nfqws –∏ userlist${reset}"

		
        
            echo
            echo "     –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å"
            echo "     0. –û—Ç–º–µ–Ω–∞"
            echo "     1. –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫"
            echo "     2. –í—Ç–æ—Ä–Ω–∏–∫"
            echo "     3. –°—Ä–µ–¥–∞"
            echo "     4. –ß–µ—Ç–≤–µ—Ä–≥"
            echo "     5. –ü—è—Ç–Ω–∏—Ü–∞"
            echo "     6. –°—É–±–±–æ—Ç–∞"
            echo "     7. –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"
            echo "     8. –ï–∂–µ–¥–Ω–µ–≤–Ω–æ"
            echo

            local day_choice
            while true; do
                read -p "  –í–∞—à –≤—ã–±–æ—Ä: " day_choice
                if [[ "$day_choice" =~ ^[0-8]$ ]]; then
                    break
                else
                    echo -e "  ${red}–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –¥–µ–π—Å—Ç–≤–∏—è.${reset} –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–æ–≤–∞"
                fi
            done

            if [ "$day_choice" -eq 0 ]; then
                echo -e "  –í—Ä–µ–º—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–æ."
            else
                if [ "$day_choice" -eq 8 ]; then
                    echo
                    read -p "  –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å (0-23): " hour
                    while [[ ! "$hour" =~ ^[0-9]+$ || "$hour" -lt 0 || "$hour" -gt 23 ]]; do
                        echo -e "  ${red}–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —á–∞—Å.${reset} –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
                        read -p "  –í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0 –¥–æ 23: " hour
                    done

                    read -p "  –í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω—É—Ç—É (0-59): " minute
                    while [[ ! "$minute" =~ ^[0-9]+$ || "$minute" -lt 0 || "$minute" -gt 59 ]]; do
                        echo -e "  ${red}–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –º–∏–Ω—É—Ç—ã.${reset} –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
                        read -p "  –í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0 –¥–æ 59: " minute
                    done

                    cron_expression="$minute $hour * * *"
                    cron_display="$minute $hour * * *"
                else
                    echo
                    read -p "  –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å (0-23): " hour
                    while [[ ! "$hour" =~ ^[0-9]+$ || "$hour" -lt 0 || "$hour" -gt 23 ]]; do
                        echo -e "  ${red}–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —á–∞—Å.${reset} –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
                        read -p "  –í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0 –¥–æ 23: " hour
                    done

                    read -p "  –í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω—É—Ç—É (0-59): " minute
                    while [[ ! "$minute" =~ ^[0-9]+$ || "$minute" -lt 0 || "$minute" -gt 59 ]]; do
                        echo -e "  ${red}–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –º–∏–Ω—É—Ç—ã.${reset} –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
                        read -p "  –í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0 –¥–æ 59: " minute
                    done

                    case "$day_choice" in
                        1) day_of_week="1" ;;
                        2) day_of_week="2" ;;
                        3) day_of_week="3" ;;
                        4) day_of_week="4" ;;
                        5) day_of_week="5" ;;
                        6) day_of_week="6" ;;
                        7) day_of_week="0" ;;
                    esac

                    cron_expression="$minute $hour * * $day_of_week"
                    cron_display="$minute $hour * * $day_of_week"
                fi

                formatted_hour=$(printf "%02d" "$hour")
                formatted_minute=$(printf "%02d" "$minute")

                day_name=""
                case "$day_choice" in
                    0) day_name="–û—Ç–º–µ–Ω–∞" ;;
                    1) day_name="–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" ;;
                    2) day_name="–í—Ç–æ—Ä–Ω–∏–∫" ;;
                    3) day_name="–°—Ä–µ–¥–∞" ;;
                    4) day_name="–ß–µ—Ç–≤–µ—Ä–≥" ;;
                    5) day_name="–ü—è—Ç–Ω–∏—Ü–∞" ;;
                    6) day_name="–°—É–±–±–æ—Ç–∞" ;;
                    7) day_name="–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ" ;;
                    8) day_name="–ï–∂–µ–¥–Ω–µ–≤–Ω–æ" ;;
                esac
                
				if [ -s "$initd_crontab" ]; then
			   cron_file=""
			   local cron_file
               echo -e "–§–∞–π–ª ${yellow}Cron${reset} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å–¥–µ–ª–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é?"
               echo -e "     1. –î–∞"
               echo -e "     0. –ù–µ—Ç"
			   
				
             while true; do
                read -p "  –í–∞—à –≤—ã–±–æ—Ä: " cron_file
				
                if [[ "$cron_file" =~ ^[0-1]$ ]]; then
                    break
                else
                    echo -e "${red}–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –¥–µ–π—Å—Ç–≤–∏—è.${reset} –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–æ–≤–∞"
					fi
            done
			if [ "$cron_file" -eq 1 ]; then  
				mkdir -p "$init_back"
                cp -a "$initd_crontab" "$init_back"
				echo -e "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è ${green}cron${reset} —Å–æ–∑–¥–∞–Ω–∞ –ø–æ –ø—É—Ç–∏ ${green}$init_back${reset}"
                sed -i "/nfqws_updater/d" /opt/var/spool/cron/crontabs/root
				echo -e "${cron_expression} nfqws_updater -update-userlist" >> "${initd_crontab}" 
				echo -e "${cron_expression} nfqws_updater -update-nfqws" >> "${initd_crontab}" 
				echo -e "${yellow}$RoutID${reset}: –í—Ä–µ–º—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${yellow} nfqws –∏ userlist${reset}: $day_name $formatted_hour:$formatted_minute";
				sendTelegram "$RoutID:‚è∞ –í—Ä–µ–º—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è nfqws –∏ userlist: $day_name $formatted_hour:$formatted_minute";
				restartcron
				fi
		        if [ "$cron_file" -eq 0 ]; then 
				sed -i "/nfqws_updater/d" /opt/var/spool/cron/crontabs/root
		        echo -e "${cron_expression} nfqws_updater -update-userlist" >> "${initd_crontab}" 
				echo -e "${cron_expression} nfqws_updater -update-nfqws" >> "${initd_crontab}" 
				echo -e "${yellow}$RoutID${reset}: –í—Ä–µ–º—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${yellow} nfqws –∏ userlist${reset}: $day_name $formatted_hour:$formatted_minute";
				sendTelegram "$RoutID:‚è∞ –í—Ä–µ–º—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è nfqws –∏ userlist: $day_name $formatted_hour:$formatted_minute";
				restartcron
				fi
				else
				sed -i "/nfqws_updater/d" /opt/var/spool/cron/crontabs/root
				echo -e "${cron_expression} nfqws_updater -update-userlist" >> "${initd_crontab}" 
				echo -e "${cron_expression} nfqws_updater -update-nfqws" >> "${initd_crontab}" 
				echo -e "${yellow}$RoutID${reset}: –í—Ä–µ–º—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${yellow} nfqws –∏ userlist${reset}: $day_name $formatted_hour:$formatted_minute";
				sendTelegram "$RoutID:‚è∞ –í—Ä–µ–º—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è nfqws –∏ userlist: $day_name $formatted_hour:$formatted_minute";
				restartcron
					fi
					
		
        
fi
}
function installnfqws {
echo -e "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ ${green}nfqws${reset}"
opkg update
opkg install ca-certificates wget-ssl
opkg remove wget-nossl
mkdir -p /opt/etc/opkg
echo "src/gz nfqws-keenetic https://anonym-tsk.github.io/nfqws-keenetic/all" > /opt/etc/opkg/nfqws-keenetic.conf
opkg update
opkg install nfqws-keenetic
opkg install nfqws-keenetic-web
sendinstallnfqws
}
function userlist {
urlList="https://raw.githubusercontent.com/Tornado6896/nfqws-updater/refs/heads/main/user.lst"
confDirNfqws="/opt/etc/nfqws"
listLocal="$confDirNfqws/user.list"
echo -e "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ ${green}userlist${reset}"
  local tsRemote=$(curl -sIkL --connect-timeout 5 "$urlList" | grep -i 'Content-Length' | tail -n 1 | sed 's|Content-Length: ||g')
  local tslocal=$(wc -c /opt/etc/nfqws/user.list | awk '{print $1}')
  if [ "$tslocal" -ne "$tsRemote" ]; then
    local count1="$(wc /opt/etc/nfqws/user.list | awk '{print $1}')"
    rm -f "$listLocal"
	curl --connect-timeout 10 -fkSL# "$urlList" > "$listLocal"
	   count2="$(wc /opt/etc/nfqws/user.list | awk '{print $1}')"
	   echo "$count2"
	   echo "$count1"
	   count3=$((count2 - count1))
    chown nobody:nobody "$listLocal"
    chmod 644 "$listLocal"
	sendupdateuserlist
	  else
    sendupdateuserlistno
  fi
  
}
function registercron {
    echo -e "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–∞–∫–µ—Ç–∞ ${green}cron${reset}"
	# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–∞–∫–µ—Ç–∞ cron
    if opkg list-installed | grep -q cron; then
        return
    fi

    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    local initd_file="/opt/etc/init.d/S05crond"
    local s05crond_filename="${current_datetime}_S05crond"
    local required_script_version="0.4"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ S05crond
    if [ -e "${initd_file}" ]; then
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞
        local script_version=$(grep 'version=' "${initd_file}" | grep -o '[0-9.]\+')

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞
        if [ "${script_version}" != "${required_script_version}" ]; then
            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
            local backup_path="/opt/etc/init.d/${s05crond_filename}"

            # –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π —Å –Ω–æ–≤—ã–º –∏–º–µ–Ω–µ–º
            mv "${initd_file}" "${backup_path}"
            echo -e "–í–∞—à —Ñ–∞–π–ª ¬´${green}S05crond${reset}¬ª –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ –∫–∞—Ç–∞–ª–æ–≥ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π ¬´${yellow}${backup_path}${reset}¬ª"
        fi
    fi

    # –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫—Ä–∏–ø—Ç–∞
    local script_content='#!/bin/sh
### –ù–∞—á–∞–ª–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–ª—É–∂–±–µ
# –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: –ó–∞–ø—É—Å–∫ / –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Cron
# version="0.4"  # –í–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞
### –ö–æ–Ω–µ—Ü –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–ª—É–∂–±–µ

green="\033[32m"
red="\033[31m"
yellow="\033[33m"
reset="\033[0m" 

cron_initd="/opt/sbin/crond"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ cron
cron_status() {
    if ps | grep -v grep | grep -q "$cron_initd"; then
        return 0 # –ü—Ä–æ—Ü–µ—Å—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
    else
        return 1 # –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ cron
start() {
    if cron_status; then
        echo -e "  Cron ${yellow}—É–∂–µ –∑–∞–ø—É—â–µ–Ω${reset}"
    else
        $cron_initd -L /dev/null
        echo -e "  Cron ${green}–∑–∞–ø—É—â–µ–Ω${reset}"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ cron
stop() {
    if cron_status; then
        killall -9 "crond"
        echo -e "  Cron ${yellow}–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${reset}"
    else
        echo -e "  Cron ${red}–Ω–µ –∑–∞–ø—É—â–µ–Ω${reset}"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ cron
restart() {
    stop > /dev/null 2>&1
    start > /dev/null 2>&1
    echo -e "  Cron ${green}–ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω${reset}"
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
case "$1" in
    start)
        start;;
    stop)
        stop;;
    restart)
        restart;;
    status)
        if cron_status; then
            echo -e "  Cron ${green}–∑–∞–ø—É—â–µ–Ω${reset}"
        else
            echo -e "  Cron ${red}–Ω–µ –∑–∞–ø—É—â–µ–Ω${reset}"
        fi;;
    *)
        echo -e "  –ö–æ–º–∞–Ω–¥—ã: ${green}start${reset} | ${red}stop${reset} | ${yellow}restart${reset} | status";;
esac

exit 0'
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –∑–∞–º–µ–Ω–∞ —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±—É–µ–º–æ–π –≤–µ—Ä—Å–∏–∏ 
    if [ "${script_version}" != "${required_script_version}" ]; then
        echo "–§–∞–π–ª S05crond —Å–æ–∑–¥–∞–Ω"	
        echo -e "${script_content}" > "${initd_file}" 
        chmod +x "${initd_file}" 
		
    fi 
}
function crontabs {
echo -e "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ ${yellow}crontab${reset}"
local initd_crontab="/opt/var/spool/cron/crontabs/root"
if [ ! -e "${initd_crontab}" ]; then
echo -e "–§–∞–π–ª ${red}crontab${reset} –Ω–µ –Ω–∞–π–¥–µ–Ω"
mkdir -p /opt/var/spool/cron/crontabs
touch /opt/var/spool/cron/crontabs/root
chmod +x "${initd_crontab}"
echo -e "–§–∞–π–ª ${green}crontab${reset} —Å–æ–∑–¥–∞–Ω";
else
echo -e "–§–∞–π–ª ${yellow}crontab${reset} —É–∂–µ —Å—É—â–µ—Å—Ç–≤–µ—Ç";
fi
}
function addpolicy {
echo -e "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ ${green}nfqws${reset}"
ndmc -c ip policy Policy0 
ndmc -c ip policy Policy0 description nfqws
ndmc -c system configuration save
sleep 10s
echo -e "${green}$RoutID${reset}: –ø–æ–ª–∏—Ç–∏–∫–∞ ${green}nfqws${reset} –¥–æ–±–∞–≤–ª–µ–Ω–∞";
if [ -n "$tgToken" -a -n "$tgChatId" ]; then
sendTelegram "$RoutID: üõ° –ø–æ–ª–∏—Ç–∏–∫–∞ nfqws –¥–æ–±–∞–≤–ª–µ–Ω–∞";
fi
}
function delpolicy {
echo -e "–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ ${green}nfqws${reset}"
ndmc -c ip no policy Policy0 
ndmc -c system configuration save
sleep 5s
echo -e "${green}$RoutID${reset}: –ø–æ–ª–∏—Ç–∏–∫–∞ ${green}nfqws${reset} —É–¥–∞–ª–µ–Ω–∞";
if [ -n "$tgToken" -a -n "$tgChatId" ]; then
sendTelegram "$RoutID: üõ° –ø–æ–ª–∏—Ç–∏–∫–∞ nfqws —É–¥–∞–ª–µ–Ω–∞";
fi
}
function dnsadd {
echo -e "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ ${green}DOT${reset}"
ndmc -c dns-proxy tls upstream 217.160.70.42 sni ns1.opennameserver.org
ndmc -c system configuration save
ndmc -c dns-proxy tls upstream 213.202.211.221 sni ns2.opennameserver.org
ndmc -c system configuration save
ndmc -c dns-proxy tls upstream 185.222.222.222 sni dot.sb
ndmc -c system configuration save
ndmc -c dns-proxy tls upstream 81.169.136.222 sni ns3.opennameserver.org
ndmc -c system configuration save
ndmc -c dns-proxy tls upstream 185.181.61.24 sni ns4.opennameserver.org
ndmc -c system configuration save
ndmc -c dns-proxy tls upstream 45.11.45.11 sni dot.sb
ndmc -c system configuration save
echo -e "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ ${green}DOT${reset}"
ndmc -c dns-proxy https upstream https://ns1.opennameserver.org/dns-query
ndmc -c system configuration save
ndmc -c dns-proxy https upstream https://ns2.opennameserver.org/dns-query
ndmc -c system configuration save
ndmc -c dns-proxy https upstream https://ns3.opennameserver.org/dns-query
ndmc -c system configuration save
ndmc -c dns-proxy https upstream https://doh.dns.sb/dns-query dnsm
ndmc -c system configuration save

echo -e "–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å dns ${green}ip4${reset}"
ndmc -c interface ISP ip dhcp client no name-servers
ndmc -c system configuration save
ndmc -c interface PPTP0 ipcp no name-servers
ndmc -c system configuration save
ndmc -c  interface UsbQmi0 mobile no name-servers
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan4 ip dhcp client no name-servers
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan1 ip dhcp client no name-servers
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan2 ip dhcp client no name-servers
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan3 ip dhcp client no name-servers
ndmc -c system configuration save
echo -e "–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å dns ${green}ip6${reset}"
ndmc -c interface ISP no ipv6 name-servers auto 
ndmc -c system configuration save
ndmc -c interface PPTP0 no ipv6 name-servers auto 
ndmc -c system configuration save
ndmc -c  interface UsbQmi0 no ipv6 name-servers auto
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan4 no ipv6 name-servers auto
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan1 no ipv6 name-servers auto
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan2 no ipv6 name-servers auto
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan3 no ipv6 name-servers auto
ndmc -c system configuration save

sleep 10s
echo -e "${green}$RoutID${reset}: ${green}DNS${reset} –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã";
if [ -n "$tgToken" -a -n "$tgChatId" ]; then
sendTelegram "$RoutID: üõ° DNS –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã";
fi
}
function deldns {

echo -e "–£–¥–∞–ª–µ–Ω–∏–µ ${green}DOH/DOT${reset}"
ndmc -c dns-proxy no tls upstream
ndmc -c dns-proxy no https upstream
ndmc -c system configuration save
echo -e "–í–æ–∑–≤—Ä–∞—Ç dns –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ ${green}ip4${reset}"
ndmc -c interface ISP ip dhcp client name-servers
ndmc -c system configuration save
ndmc -c interface PPTP0 ipcp name-servers
ndmc -c system configuration save
ndmc -c  interface UsbQmi0 mobile name-servers
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan4 ip dhcp client name-servers
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan1 ip dhcp client name-servers
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan2 ip dhcp client name-servers
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan3 ip dhcp client name-servers
ndmc -c system configuration save
echo -e "–í–æ–∑–≤—Ä–∞—Ç dns –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ ${green}ip6${reset}"
ndmc -c interface ISP ipv6 name-servers auto 
ndmc -c system configuration save
ndmc -c interface PPTP0 ipv6 name-servers auto 
ndmc -c system configuration save
ndmc -c  interface UsbQmi0 ipv6 name-servers auto
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan4 ipv6 name-servers auto
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan1 ipv6 name-servers auto
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan2 ipv6 name-servers auto
ndmc -c system configuration save
ndmc -c  interface GigabitEthernet0/Vlan3 ipv6 name-servers auto
ndmc -c system configuration save

sleep 5s
echo -e "${green}$RoutID${reset}: ${green}DNS${reset} –∑–∞–ø–∏—Å–∏ —É–¥–∞–ª–µ–Ω—ã";
if [ -n "$tgToken" -a -n "$tgChatId" ]; then
sendTelegram "$RoutID: üõ° DNS –∑–∞–ø–∏—Å–∏ —É–¥–∞–ª–µ–Ω—ã";
fi
}

function installfull {
token; 
installnfqws;
userlist;
rm -r /opt/root/_i.sh
registercron;
crontabs;
dnsadd;
addpolicy;
crontime;
echo -e "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è ${green}nfqws_updater${reset} $1 \n${green}-menu${reset} - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
${green}-update-userlist${reset} - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ userlist
${green}-update-nfqws${reset} - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ nfqws
${green}-token${reset} - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–ª–µ–≥—Ä–∞–º–∞
${green}-restart-nfqws${reset} - –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nfqws
${green}-remove-nfqws${reset} - –£–¥–∞–ª–µ–Ω–∏–µ nfqws
${green}-del-dns${reset} - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ DNS –∑–∞–ø–∏—Å–µ–π
${green}-del-dns${reset} - –£–¥–∞–ª–µ–Ω–∏–µ DNS –∑–∞–ø–∏—Å–µ–π
${green}-add-policy${reset} - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ nfqws
${green}-del-policy${reset} - –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ nfqws
${green}-install-nfqws${reset} - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ nfqws
${green}-restart-cron${reset} - –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ cron
${green}-install-nfqws-full${reset} - –ü–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ nfqws
${green}-time-update${reset} - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π nfqws –∏ userlist"
}
case "$1" in
    -menu)
    menu
	;;
	-update-nfqws)
    updatenfqws
	;;
	-update-userlist)
    userlist
	;;
	-token)
    token
	;;
	-remove-nfqws)
    removenfqws
	;;
	-restart-nfqws)
    restartnfqws
	;;
	-install-nfqws)
    installnfqws
	;;
	-install-nfqws-full)
    installfull
	;;
	-time-update)
    crontime
	;;
	-restart-cron)
    restartcron
	;;
	-del-dns)
    deldns
	;;
	-del-dns)
    dnsadd
	;;
	-add-policy)
    addpolicy
	;;
	-del-policy)
    delpolicy
	;;
	*)

echo -e "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è ${green}nfqws_updater${reset} $1 \n${green}-menu${reset} - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
${green}-update-userlist${reset} - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ userlist
${green}-update-nfqws${reset} - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ nfqws
${green}-token${reset} - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–ª–µ–≥—Ä–∞–º–∞
${green}-restart-nfqws${reset} - –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nfqws
${green}-remove-nfqws${reset} - –£–¥–∞–ª–µ–Ω–∏–µ nfqws
${green}-del-dns${reset} - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ DNS –∑–∞–ø–∏—Å–µ–π
${green}-del-dns${reset} - –£–¥–∞–ª–µ–Ω–∏–µ DNS –∑–∞–ø–∏—Å–µ–π
${green}-add-policy${reset} - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ nfqws
${green}-del-policy${reset} - –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ nfqws
${green}-install-nfqws${reset} - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ nfqws
${green}-restart-cron${reset} - –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ cron
${green}-install-nfqws-full${reset} - –ü–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ nfqws
${green}-time-update${reset} - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π nfqws –∏ userlist"
esac